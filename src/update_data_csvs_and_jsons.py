# getting dependencies
import pandas as pd
import random
import requests
import urllib.request
# this imports all of the functions from the file functions.py
from functions import *
from bs4 import BeautifulSoup
from PIL import Image

pd.options.mode.chained_assignment = None # default='warn' (disables SettingWithCopyWarning)

# grab current data stored in csv files
fight_hist_old = pd.read_csv('models/buildingMLModel/data/processed/fight_hist.csv')
fighter_stats_old = pd.read_csv('models/buildingMLModel/data/processed/fighter_stats.csv')

# bring csv files up to date
print('scraping new statistics from ufcstats.com')
fight_hist_updated = update_fight_stats(fight_hist_old)
fighter_stats_updated = update_fighter_details(fight_hist_updated.fighter_url.unique(), fighter_stats_old)
fight_hist_updated.to_csv('models/buildingMLModel/data/processed/fight_hist.csv', index=False)
fighter_stats_updated.to_csv('models/buildingMLModel/data/processed/fighter_stats.csv', index=False)

# At the end, we have files fight_hist.csv and fighter_stats.csv which we can use to construct a dataframe in building_ufc_fights and building_ufc_fighters
# updated scraped fight data (after running fight_hist_updated function from UFC_data_scraping file)
fight_hist = pd.read_csv('models/buildingMLModel/data/processed/fight_hist.csv', sep=',')
# all stats fight history file which is one update behind fight_hist
ufcfightscrap = pd.read_csv('models/buildingMLModel/data/processed/ufc_fights_crap.csv', sep=',', low_memory=False)
# updated scraped fighter data (after running fight_hist_updated function from UFC_data_scraping file)
ufcfighterscrap = pd.read_csv('models/buildingMLModel/data/processed/fighter_stats.csv', sep=',')
# most recent fight in fight_hist versus most recent fight in ufcfightscrap

update_time = time_diff(ufcfightscrap['date'][0], fight_hist['date'][0])
print('days since last update: '+str(update_time))
# this gives the new rows in fight_hist which do not appear in ufcfightscrapd
new_rows = fight_hist.loc[time_diff_vect(fight_hist['date'], fight_hist['date'][0]) < update_time]
# convert to numpy array
numpy_new_rows = new_rows.values
# gives new_rows as a dataframe instead of a clone
test_new_rows = pd.DataFrame(data = numpy_new_rows, columns = new_rows.columns)

if update_time > 0:
    populate_new_fights_with_statistics(test_new_rows)
    # making sure new columns coincide with old columns
    crapcolumns = list(ufcfightscrap.columns)
    test_new_rows = test_new_rows[crapcolumns]
    print('New columns coincide with old columns: ' + str(all(ufcfightscrap.columns == test_new_rows.columns)))
    print('joining new data to ufc_fights_crap.csv')

else:
    print('nothing to update')
frames = [test_new_rows, ufcfightscrap]
updated_ufcfightscrap = pd.concat(frames, ignore_index=True)

# saving the updated ufcfightscrap file
updated_ufcfightscrap.to_csv('models/buildingMLModel/data/processed/ufc_fights_crap.csv', index=False)

# here is the list of all stats available (besides stance), does not include names or result
computed_statistics = [u'fighter_wins', u'fighter_losses', u'fighter_age', u'fighter_height', u'fighter_reach', u'fighter_L5Y_wins', u'fighter_L5Y_losses', 
                       u'fighter_L2Y_wins', u'fighter_L2Y_losses', u'fighter_ko_wins', u'fighter_ko_losses', u'fighter_L5Y_ko_wins', u'fighter_L5Y_ko_losses', 
                       u'fighter_L2Y_ko_wins', u'fighter_L2Y_ko_losses', u'fighter_sub_wins', u'fighter_sub_losses', u'fighter_L5Y_sub_wins', u'fighter_L5Y_sub_losses', 
                       u'fighter_L2Y_sub_wins', u'fighter_L2Y_sub_losses', u'fighter_inf_knockdowns_avg', u'fighter_inf_pass_avg', u'fighter_inf_reversals_avg', 
                       u'fighter_inf_sub_attempts_avg', u'fighter_inf_takedowns_landed_avg', u'fighter_inf_takedowns_attempts_avg', u'fighter_inf_sig_strikes_landed_avg', 
                       u'fighter_inf_sig_strikes_attempts_avg', u'fighter_inf_total_strikes_landed_avg', u'fighter_inf_total_strikes_attempts_avg', 
                       u'fighter_inf_head_strikes_landed_avg', u'fighter_inf_head_strikes_attempts_avg', u'fighter_inf_body_strikes_landed_avg', 
                       u'fighter_inf_body_strikes_attempts_avg', u'fighter_inf_leg_strikes_landed_avg', u'fighter_inf_leg_strikes_attempts_avg', 
                       u'fighter_inf_distance_strikes_landed_avg', u'fighter_inf_distance_strikes_attempts_avg', u'fighter_inf_clinch_strikes_landed_avg', 
                       u'fighter_inf_clinch_strikes_attempts_avg', u'fighter_inf_ground_strikes_landed_avg', u'fighter_inf_ground_strikes_attempts_avg', 
                       u'fighter_abs_knockdowns_avg', u'fighter_abs_pass_avg', u'fighter_abs_reversals_avg', u'fighter_abs_sub_attempts_avg', 
                       u'fighter_abs_takedowns_landed_avg', u'fighter_abs_takedowns_attempts_avg', u'fighter_abs_sig_strikes_landed_avg', 
                       u'fighter_abs_sig_strikes_attempts_avg', u'fighter_abs_total_strikes_landed_avg', u'fighter_abs_total_strikes_attempts_avg', 
                       u'fighter_abs_head_strikes_landed_avg', u'fighter_abs_head_strikes_attempts_avg', u'fighter_abs_body_strikes_landed_avg', 
                       u'fighter_abs_body_strikes_attempts_avg', u'fighter_abs_leg_strikes_landed_avg', u'fighter_abs_leg_strikes_attempts_avg', 
                       u'fighter_abs_distance_strikes_landed_avg', u'fighter_abs_distance_strikes_attempts_avg', u'fighter_abs_clinch_strikes_landed_avg', 
                       u'fighter_abs_clinch_strikes_attempts_avg', u'fighter_abs_ground_strikes_landed_avg', u'fighter_abs_ground_strikes_attempts_avg', u'opponent_wins', 
                       u'opponent_losses', u'opponent_age',  u'opponent_height', u'opponent_reach', u'opponent_L5Y_wins', u'opponent_L5Y_losses', u'opponent_L2Y_wins', 
                       u'opponent_L2Y_losses', u'opponent_ko_wins', u'opponent_ko_losses', u'opponent_L5Y_ko_wins', u'opponent_L5Y_ko_losses', u'opponent_L2Y_ko_wins',
                       u'opponent_L2Y_ko_losses', u'opponent_sub_wins', u'opponent_sub_losses', u'opponent_L5Y_sub_wins', u'opponent_L5Y_sub_losses', 
                       u'opponent_L2Y_sub_wins', u'opponent_L2Y_sub_losses', u'opponent_inf_knockdowns_avg', u'opponent_inf_pass_avg', u'opponent_inf_reversals_avg', 
                       u'opponent_inf_sub_attempts_avg', u'opponent_inf_takedowns_landed_avg', u'opponent_inf_takedowns_attempts_avg', u'opponent_inf_sig_strikes_landed_avg',
                       u'opponent_inf_sig_strikes_attempts_avg', u'opponent_inf_total_strikes_landed_avg', u'opponent_inf_total_strikes_attempts_avg', 
                       u'opponent_inf_head_strikes_landed_avg', u'opponent_inf_head_strikes_attempts_avg', u'opponent_inf_body_strikes_landed_avg',
                       u'opponent_inf_body_strikes_attempts_avg', u'opponent_inf_leg_strikes_landed_avg', u'opponent_inf_leg_strikes_attempts_avg', 
                       u'opponent_inf_distance_strikes_landed_avg', u'opponent_inf_distance_strikes_attempts_avg', u'opponent_inf_clinch_strikes_landed_avg', 
                       u'opponent_inf_clinch_strikes_attempts_avg', u'opponent_inf_ground_strikes_landed_avg', u'opponent_inf_ground_strikes_attempts_avg', 
                       u'opponent_abs_knockdowns_avg', u'opponent_abs_pass_avg', u'opponent_abs_reversals_avg', u'opponent_abs_sub_attempts_avg', 
                       u'opponent_abs_takedowns_landed_avg', u'opponent_abs_takedowns_attempts_avg', u'opponent_abs_sig_strikes_landed_avg', 
                       u'opponent_abs_sig_strikes_attempts_avg', u'opponent_abs_total_strikes_landed_avg', u'opponent_abs_total_strikes_attempts_avg', 
                       u'opponent_abs_head_strikes_landed_avg', u'opponent_abs_head_strikes_attempts_avg', u'opponent_abs_body_strikes_landed_avg', 
                       u'opponent_abs_body_strikes_attempts_avg', u'opponent_abs_leg_strikes_landed_avg', u'opponent_abs_leg_strikes_attempts_avg', 
                       u'opponent_abs_distance_strikes_landed_avg', u'opponent_abs_distance_strikes_attempts_avg', u'opponent_abs_clinch_strikes_landed_avg', 
                       u'opponent_abs_clinch_strikes_attempts_avg', u'opponent_abs_ground_strikes_landed_avg', u'opponent_abs_ground_strikes_attempts_avg', 
                       u'fighter_stance', u'opponent_stance', '1-fight_math', '6-fight_math', '4-fighter_score_diff', '9-fighter_score_diff', '15-fighter_score_diff',]

# list containing all columns of any interest
relevant_list = ['date', 'division', 'fighter', 'opponent', 'result', 'method']
relevant_list.extend(computed_statistics)

# creates a clean file with only columns which are relevant to predicting
updated_ufc_fights = updated_ufcfightscrap[relevant_list]

# lets randomly remove one of every two copied fights
random_indices = []
for i in range(0, len(updated_ufc_fights['fighter_wins']), 2):
    random_indices.append(random.choice([i, i+1]))

updated_ufc_fights = updated_ufc_fights.drop(random_indices)

print('cleaning data and adding new cleaned columns to ufc_fights.csv')

# we worked hard to build this, lets save it (only run this once we're sure that the new file is correct)
updated_ufc_fights.to_csv(
    'models/buildingMLModel/data/processed/ufc_fights.csv', index=False)

print('sending updated fighter_stats.csv to fighter_stats.json')
# convert fighter_stats.csv to json files to read via javascript in website
csvFilePath = r'models/buildingMLModel/data/processed/fighter_stats.csv'
jsonFilePath = r'models/buildingMLModel/data/external/fighter_stats.json'
make_json(csvFilePath, jsonFilePath, 'name')

updated_ufcfightscrap['index'] = updated_ufcfightscrap['fighter']
for i in range(len(updated_ufcfightscrap['date'])):
    updated_ufcfightscrap['index'][i] = i

json_columns = ['date', 'result', 'fighter', 'opponent', 'division', 'method', 'round', 'time', 'knockdowns', 'sub_attempts', 'pass', 'reversals', 'takedowns_landed', 
                'takedowns_attempts', 'sig_strikes_landed', 'sig_strikes_attempts', 'total_strikes_landed', 'total_strikes_attempts', 'head_strikes_landed',
                'head_strikes_attempts', 'body_strikes_landed', 'body_strikes_attempts', 'leg_strikes_landed', 'leg_strikes_attempts', 'distance_strikes_landed', 
                'distance_strikes_attempts', 'clinch_strikes_landed', 'clinch_strikes_attempts', 'ground_strikes_landed', 'ground_strikes_attempts', 'fighter_stance', 
                'opponent_stance', 'index',]

ufcfightscrap_for_json = updated_ufcfightscrap[json_columns]

# make new csv just to send it to json
# this is inefficient and wastes space... but its just because its the only way I know to make a json file
# of the correct format (fix needed but not super important)
print('exporting updated ufcfightscrap.json for use in javascript portion of website')
ufcfightscrap_for_json.to_csv('models/buildingMLModel/data/processed/ufcfightscrap.csv', index=False)

# convert fighter_stats.csv to json files to read via javascript in website
csvFilePath = r'models/buildingMLModel/data/processed/ufcfightscrap.csv'
jsonFilePath = r'models/buildingMLModel/data/external/ufcfightscrap.json'
make_json(csvFilePath, jsonFilePath, 'index')

# updating the picture scrape
names = list(ufcfighterscrap['name'])


def scrape_pictures(name):
    try:
        URL = "https://www.google.com/search?q="+name+" ufc fighting" + \
            "&sxsrf=ALeKk03xBalIZi7BAzyIRw8R4_KrIEYONg:1620885765119&source=lnms&tbm=isch&sa=X&ved=2ahUKEwjv44CC_sXwAhUZyjgGHSgdAQ8Q_AUoAXoECAEQAw&cshid=1620885828054361"
        page = requests.get(URL)
        soup = BeautifulSoup(page.content, 'html.parser')
        # ... or ... image_tags = soup.find_all('img', class_='t0fcAb')
        image_tags = soup.find_all('img')
        links = []
        for image_tag in image_tags:
            links.append(image_tag['src'])
            name_reduced = name.replace(" ", "")
        for i in range(1, 5):
            urllib.request.urlretrieve(
                links[i], "models/buildingMLModel/images/"+str(i)+name_reduced+".jpg")
        print('scraped 5 random pictures of '+name+' from Google search')

    except:
        print('The scrape did not work for '+name)


print('Scraping pictures of newly added fighters from Google image search')
# run this to update the image scrape
for name in names:
    try:
        name_reduced = name.replace(" ", "")
        k = Image.open("models/buildingMLModel/images/" +
                       str(1)+name_reduced+".jpg")
    except:
        scrape_pictures(name)
